#!/bin/sh

conf_dir=/etc/pi_video_matrix
conf_file="$conf_dir"/default.layout.conf
feeds_file="$conf_dir"/feeds.conf

display_width=`cat /sys/class/graphics/fb0/virtual_size | cut -d, -f1`
display_height=`cat /sys/class/graphics/fb0/virtual_size | cut -d, -f2`

if [ "$1" -ge 2 ] && [ "$1" -le 4 ]; then
	columns=2
	rows=2
elif [ "$1" -ge 5 ] && [ "$1" -le 6 ]; then
	columns=3
	rows=2
elif [ "$1" -gt 6 ]; then
	columns=3
	rows=3
else
	columns=1
	rows=1
fi

printf '\n' >> "$feeds_file"
sed -i '/^\s*$/d' "$feeds_file"
feeds=`wc -l < "$feeds_file"`
offscreen=$((feeds-columns*rows))

column_width=$((display_width/columns))
row_height=$((display_height/rows))

for row in `seq 1 $rows`
do
	y1=$((row_height*(row-1)))
	y2=$((row_height*row))
	for col in `seq 1 $columns`
	do
		x1=$((column_width*(col-1)))
		x2=$((column_width*col))
		window_positions="$window_positions\"$x1 $y1 $x2 $y2\" \\\\\n"
		windows="${windows}r${row}_c$col "
	done
done

for i in `seq 1 $offscreen`
do
	x1=0
	y1=$display_height
	x2=$column_width
	y2=$((y1+row_height))
	window_positions="$window_positions\"$x1 $y1 $x2 $y2\" \\\\\n"
	windows="${windows}off_$i "
done

echo "# This conf file is automatically generated by the gen_matrix program for the displaycamera program." > $conf_file
printf "# Any changes made will be overwritten upon restart. This file is here for information only.\n" >> $conf_file
echo "windows=($windows)" >> $conf_file
printf "window_positions=(\n$window_positions)\n" >> $conf_file
echo "camera_names=($windows)" >> $conf_file

while read -r line
do
	line=`echo $line | tr -d '\r'`
	camera_feeds="$camera_feeds\"$line\" \\\\\n"
done < "$feeds_file"

printf "camera_feeds=(\n$camera_feeds)\n" >> $conf_file

if [ "$feeds" -gt "$1" ]; then
	echo "rotate=true" >> $conf_file
fi
